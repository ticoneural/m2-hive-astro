---
import {
    MapPin,
    BedDouble,
    Bath,
    Car,
    Maximize,
    ArrowUpRight,
} from "lucide-astro";
import type { Product } from "../types";

export interface Props {
    listing: Product;
}

const { listing } = Astro.props;

const priceFormatted = new Intl.NumberFormat("en-US", {
    style: "currency",
    currency: listing.currency || "USD",
    maximumFractionDigits: 0,
}).format(listing.price);

const specs = {
    size: listing.specifications?.size_m2 || listing.specifications?.size || 0,
    beds:
        listing.specifications?.bedrooms ||
        listing.specifications?.cuartos ||
        0,
    baths:
        listing.specifications?.bathrooms || listing.specifications?.baños || 0,
    parking:
        listing.specifications?.parking_spaces ||
        listing.specifications?.garaje ||
        0,
    location: listing.category_name || "Ubicación Premium",
};

// Logic for badges (simulated based on logic)
const isNew =
    listing.condition === "Nuevo" || listing.condition === "new" || false;
const isOpportunity = listing.price < 250000;

let statusLabel = "En Venta";
let statusColor = "bg-emerald-600";

if (listing.transaction_type === "rent") {
    statusLabel = "Alquiler";
    statusColor = "bg-blue-600";
} else if (
    listing.stock_status === "out_of_stock" ||
    listing.stock_status === "sold"
) {
    statusLabel = "Vendido";
    statusColor = "bg-gray-500";
} else if (listing.stock_status === "reserved") {
    statusLabel = "Reservado";
    statusColor = "bg-amber-500";
} else {
    statusLabel = "Venta";
    statusColor = "bg-emerald-600";
}

// Fallback logic for images
const coverImage = listing.thumbnail || "/assets/hero-slider/hero-1.png";
---

<a
    href={`/propiedades/${listing.sku}`}
    class="group block bg-white border border-gray-200 rounded-sm overflow-hidden hover:border-brand-accent/50 hover:shadow-xl transition-all duration-300 relative flex flex-col h-full"
>
    <!-- Image Header -->
    <div class="relative aspect-[4/3] overflow-hidden bg-gray-100">
        <!-- Status Badge -->
        <div class="absolute top-3 left-3 z-20 flex flex-col gap-2">
            <span
                class={`text-[10px] font-bold uppercase tracking-wider text-white px-3 py-1 rounded-sm shadow-sm ${statusColor}`}
            >
                {statusLabel}
            </span>
            {
                isNew && (
                    <span class="text-[10px] font-bold uppercase tracking-wider text-[#0A192F] bg-white px-3 py-1 rounded-sm shadow-sm border border-gray-100">
                        NUEVO
                    </span>
                )
            }
        </div>

        <div class="absolute inset-0 bg-gray-200 animate-pulse shimmer"></div>

        <img
            src={coverImage}
            alt={listing.title}
            loading="lazy"
            decoding="async"
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105 relative z-10"
            onload="this.previousElementSibling.style.display='none'"
            onerror="this.src='/assets/hero-slider/hero-1.png';"
        />

        <!-- Overlay Gradient -->
        <div
            class="absolute inset-0 bg-gradient-to-t from-[#0A192F]/60 via-transparent to-transparent opacity-60 group-hover:opacity-40 transition-opacity z-10 pointer-events-none"
        >
        </div>
    </div>

    <!-- Content Body -->
    <div class="p-5 flex flex-col flex-1">
        <!-- Location & Code -->
        <div class="flex justify-between items-center mb-2">
            <div
                class="flex items-center text-gray-500 text-[10px] uppercase tracking-wider font-bold"
            >
                <MapPin size={12} class="mr-1 text-brand-accent" />
                {specs.location}
            </div>
            <span class="text-[10px] font-mono text-gray-300"
                >REF: {listing.id}</span
            >
        </div>

        <!-- Title -->
        <h3
            class="text-base font-bold text-[#0A192F] line-clamp-1 mb-1 group-hover:text-brand-accent transition-colors"
        >
            {listing.title}
        </h3>

        <!-- Price -->
        <div
            class="text-xl font-bold text-[#0A192F] mb-4 tracking-tight font-serif"
        >
            {priceFormatted}
        </div>

        <!-- Specs Grid -->
        <div
            class="grid grid-cols-4 gap-2 border-t border-gray-100 pt-4 mt-auto"
        >
            <div class="flex flex-col items-center justify-center text-center">
                <BedDouble
                    size={16}
                    class="text-gray-400 mb-1 group-hover:text-brand-accent transition-colors"
                />
                <span class="text-xs font-bold text-gray-600">{specs.beds}</span
                >
                <span class="text-[9px] text-gray-400 uppercase">Hab</span>
            </div>
            <div
                class="flex flex-col items-center justify-center text-center border-l border-gray-100"
            >
                <Bath
                    size={16}
                    class="text-gray-400 mb-1 group-hover:text-brand-accent transition-colors"
                />
                <span class="text-xs font-bold text-gray-600"
                    >{specs.baths}</span
                >
                <span class="text-[9px] text-gray-400 uppercase">Baños</span>
            </div>
            <div
                class="flex flex-col items-center justify-center text-center border-l border-gray-100"
            >
                <Car
                    size={16}
                    class="text-gray-400 mb-1 group-hover:text-brand-accent transition-colors"
                />
                <span class="text-xs font-bold text-gray-600"
                    >{specs.parking}</span
                >
                <span class="text-[9px] text-gray-400 uppercase">Parq</span>
            </div>
            <div
                class="flex flex-col items-center justify-center text-center border-l border-gray-100"
            >
                <Maximize
                    size={16}
                    class="text-gray-400 mb-1 group-hover:text-brand-accent transition-colors"
                />
                <span class="text-xs font-bold text-gray-600">{specs.size}</span
                >
                <span class="text-[9px] text-gray-400 uppercase">m²</span>
            </div>
        </div>
    </div>
</a>
