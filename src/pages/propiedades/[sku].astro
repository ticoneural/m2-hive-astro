---
import Layout from "../../layouts/Layout.astro";
import PropertyGallery from "../../components/PropertyGallery.astro";
import ListingCard from "../../components/ListingCard.astro";
import {
    Phone,
    MessageCircle,
    MapPin,
    BedDouble,
    Bath,
    Car,
    Maximize,
    FileText,
    ShieldCheck,
} from "lucide-astro";
import type { Product } from "../../types";

export const prerender = false; // Ensure server-side rendering for dynamic fetching

const { sku } = Astro.params;
let product: Product | null = null;
let similarProducts: Product[] = [];
let error = null;

if (!sku) {
    return Astro.redirect("/404");
}

try {
    // Fetch main product
    const response = await fetch(
        `https://api-m2.agenticantnest.com/api/v1/products/${sku}`,
    );
    if (!response.ok) {
        if (response.status === 404) return Astro.redirect("/404");
        throw new Error(`API Error: ${response.statusText}`);
    }
    product = await response.json();

    // Fetch similar products (same category)
    if (product && product.category_name) {
        // Changed category to category_name based on API usually
        const allRes = await fetch(
            "https://api-m2.agenticantnest.com/api/v1/products",
        );
        if (allRes.ok) {
            const allData = await allRes.json();
            const allProducts: Product[] = allData.data || [];
            similarProducts = allProducts
                .filter(
                    (p) =>
                        p.category_name === product?.category_name &&
                        p.sku !== product?.sku,
                )
                .slice(0, 3);
        }
    }
} catch (e) {
    console.error(e);
    error = "Propiedad no encontrada o error de conexión.";
}

if (!product) {
    return Astro.redirect("/404");
}

// Specs Mapping
const specs = {
    beds:
        product.specifications?.bedrooms ||
        product.specifications?.cuartos ||
        "0",
    baths:
        product.specifications?.bathrooms ||
        product.specifications?.baños ||
        "0",
    sqm:
        product.specifications?.size ||
        product.specifications?.size_m2 ||
        product.specifications?.metros ||
        "0",
    parking:
        product.specifications?.parking_spaces ||
        product.specifications?.parking ||
        product.specifications?.parqueo ||
        "0",
    location: product.category_name || "Ubicación Privilegiada",
};

const formatPrice = (val: number, currency = "USD") => {
    return new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: currency,
        maximumFractionDigits: 0,
    }).format(val || 0);
};

// WhatsApp Link Generator
const waMessage = `Hola, estoy interesado en ${product.title} (REF: ${product.sku}). Quisiera más información.`;
const waLink = `https://wa.me/50687332630?text=${encodeURIComponent(waMessage)}`;

const title = `${product.title} | M2 Real Estate`;
const description = product.description
    ? product.description.substring(0, 160) + "..."
    : `Propiedad exclusiva en ${specs.location}.`;
const image = product.thumbnail || "/og-default.jpg";

// Translation map for specs
const keyTranslation: Record<string, string> = {
    view: "Vista",
    levels: "Niveles",
    floors: "Pisos",
    year_built: "Año de Construcción",
    style: "Estilo",
    condition: "Condición",
    lot_size: "Tamaño Lote",
    construction_size: "Área Construcción",
    zoning: "Zonificación",
    security: "Seguridad",
    furnished: "Amueblado"
};
---

<Layout title={title} description={description} image={image}>
    <!-- Mobile Sticky Action Bar (Visible only on mobile) -->
    <div
        class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-4 z-50 flex gap-4 md:hidden shadow-[0_-4px_20px_rgba(0,0,0,0.1)]"
    >
        <a
            href={`tel:+50687332630`}
            class="flex-1 flex items-center justify-center gap-2 bg-gray-100 text-[#0A192F] font-bold uppercase text-xs py-3 rounded-sm"
        >
            <Phone size={16} /> Llamar
        </a>
        <a
            href={waLink}
            target="_blank"
            class="flex-1 flex items-center justify-center gap-2 bg-green-600 text-white font-bold uppercase text-xs py-3 rounded-sm shadow-md"
        >
            <MessageCircle size={16} /> WhatsApp
        </a>
    </div>

    <!-- Gallery / Hero -->
    <div class="relative h-[60vh] md:h-[70vh] bg-gray-900 overflow-hidden">
        {
            product.images && product.images.length > 0 ? (
                <img
                    src={product.images[0]}
                    alt={product.title}
                    class="w-full h-full object-cover object-center opacity-90 transition-transform duration-1000 scale-105"
                />
            ) : (
                <img
                    src="/assets/hero-slider/hero-1.png"
                    alt="Fallback"
                    class="w-full h-full object-cover object-center opacity-50"
                />
            )
        }
        <div
            class="absolute inset-0 bg-gradient-to-t from-[#0A192F] via-transparent to-transparent opacity-90"
        >
        </div>

        <div class="absolute bottom-0 left-0 w-full p-6 md:p-16 z-10">
            <div class="container mx-auto">
                <div
                    class="flex flex-col md:flex-row justify-between items-end gap-6"
                >
                    <div class="space-y-4 max-w-3xl">
                        <span
                            class="inline-flex items-center gap-2 px-3 py-1 bg-brand-accent/90 text-[#0A192F] text-[10px] font-bold uppercase tracking-widest rounded-sm backdrop-blur-md"
                        >
                            <MapPin size={12} />
                            {specs.location}
                        </span>
                        <h1
                            class="text-3xl md:text-5xl font-serif text-white font-bold leading-tight shadow-black drop-shadow-lg"
                        >
                            {product.title}
                        </h1>
                        <p
                            class="text-gray-300 text-sm md:text-base font-light flex items-center gap-2"
                        >
                            <span class="font-mono text-brand-accent"
                                >REF: {product.sku}</span
                            > | Gestión Exclusiva M2
                        </p>
                    </div>
                    <div class="text-right hidden md:block">
                        <p
                            class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-1"
                        >
                            Precio de Venta
                        </p>
                        <p class="text-4xl font-serif text-white font-bold">
                            {formatPrice(product.price, product.currency)}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-12 pb-32">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
            <!-- Left Column: Content -->
            <div class="lg:col-span-8 space-y-12">
                <!-- Key Specs Bar -->
                <div
                    class="grid grid-cols-2 md:grid-cols-4 gap-4 p-6 bg-gray-50 rounded-sm border border-gray-100"
                >
                    <div
                        class="flex flex-col items-center justify-center text-center p-2"
                    >
                        <Maximize size={24} class="text-brand-accent mb-2" />
                        <span class="text-lg font-bold text-[#0A192F]"
                            >{specs.sqm}</span
                        >
                        <span
                            class="text-[10px] uppercase text-gray-400 font-bold tracking-wider"
                            >m² Privados</span
                        >
                    </div>
                    <div
                        class="flex flex-col items-center justify-center text-center p-2 border-l border-gray-200"
                    >
                        <BedDouble size={24} class="text-brand-accent mb-2" />
                        <span class="text-lg font-bold text-[#0A192F]"
                            >{specs.beds}</span
                        >
                        <span
                            class="text-[10px] uppercase text-gray-400 font-bold tracking-wider"
                            >Habitaciones</span
                        >
                    </div>
                    <div
                        class="flex flex-col items-center justify-center text-center p-2 border-l border-gray-200"
                    >
                        <Bath size={24} class="text-brand-accent mb-2" />
                        <span class="text-lg font-bold text-[#0A192F]"
                            >{specs.baths}</span
                        >
                        <span
                            class="text-[10px] uppercase text-gray-400 font-bold tracking-wider"
                            >Baños</span
                        >
                    </div>
                    <div
                        class="flex flex-col items-center justify-center text-center p-2 border-l border-gray-200"
                    >
                        <Car size={24} class="text-brand-accent mb-2" />
                        <span class="text-lg font-bold text-[#0A192F]"
                            >{specs.parking}</span
                        >
                        <span
                            class="text-[10px] uppercase text-gray-400 font-bold tracking-wider"
                            >Estacionamientos</span
                        >
                    </div>
                </div>

                <!-- Description -->
                <div class="prose prose-slate max-w-none">
                    <h3
                        class="text-lg font-bold uppercase tracking-widest text-[#0A192F] mb-6 flex items-center gap-2"
                    >
                        <FileText size={20} class="text-brand-accent" /> Descripción
                        del Activo
                    </h3>
                    <div
                        class="text-[#0A192F]/80 text-base md:text-lg leading-loose font-normal space-y-4 text-justify whitespace-pre-line border-l-2 border-brand-accent/30 pl-6"
                    >
                        {
                            product.description ||
                                "Esta propiedad cuenta con acabados de primera calidad, ubicación estratégica y excelente plusvalía. Contacte a nuestro equipo para conocer todos los detalles técnicos y legales."
                        }
                    </div>
                </div>

                <!-- Amenities (New Field) -->
                {
                    product.specifications?.amenities &&
                        Array.isArray(product.specifications.amenities) &&
                        product.specifications.amenities.length > 0 && (
                            <div class="bg-white border border-gray-200 rounded-sm overflow-hidden p-8">
                                <h3 class="text-sm font-bold uppercase tracking-widest text-[#0A192F] mb-6 flex items-center gap-2">
                                    <ShieldCheck
                                        size={18}
                                        class="text-brand-accent"
                                    />{" "}
                                    Comodidades y Servicios
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {product.specifications.amenities.map(
                                        (amenity) => (
                                            <div class="flex items-center gap-2 text-sm text-gray-600">
                                                <span class="w-1.5 h-1.5 bg-brand-accent rounded-full" />
                                                <span>{amenity}</span>
                                            </div>
                                        ),
                                    )}
                                </div>
                            </div>
                        )
                }

                <!-- Technical Sheet (Ficha Técnica) -->
                {product.specifications && (
                    <div class="bg-white border border-gray-200 rounded-sm overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <h3 class="text-sm font-bold uppercase tracking-widest text-[#0A192F]">Ficha Técnica Detallada</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-gray-100">
                            <!-- Left Col -->
                            <div class="p-6 space-y-4">
                                {product.specifications.maintenance_fee && (
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-gray-500 capitalize">Cuota Mantenimiento</span>
                                        <span class="font-bold text-[#0A192F]">{product.specifications.maintenance_fee}</span>
                                    </div>
                                )}
                                {Object.entries(product.specifications).slice(0, Math.ceil(Object.keys(product.specifications).length / 2)).map(([key, val]) => {
                                    const label = keyTranslation[key] || key.replace(/_/g, ' ');
                                    
                                    return !['bedrooms', 'bathrooms', 'size_m2', 'parking', 'cuartos', 'baños', 'metros', 'parqueo', 'location', 'amenities', 'maintenance_fee', 'parking_spaces', 'size'].includes(key) && (
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-gray-500 capitalize">{label}</span>
                                        <span class="font-bold text-[#0A192F]">{String(val)}</span>
                                    </div>
                                    );
                                })}
                            </div>
                            <!-- Right Col -->
                            <div class="p-6 space-y-4">
                                {Object.entries(product.specifications).slice(Math.ceil(Object.keys(product.specifications).length / 2)).map(([key, val]) => {
                                    const label = keyTranslation[key] || key.replace(/_/g, ' ');

                                    return !['bedrooms', 'bathrooms', 'size_m2', 'parking', 'cuartos', 'baños', 'metros', 'parqueo', 'location', 'amenities', 'maintenance_fee', 'parking_spaces', 'size'].includes(key) && (
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-gray-500 capitalize">{label}</span>
                                        <span class="font-bold text-[#0A192F]">{String(val)}</span>
                                    </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </div>
    </div>

    <!-- Gallery Grid if multiple images -->
    {
        product.images && product.images.length > 1 && (
            <div class="space-y-6">
                <h3 class="text-lg font-bold uppercase tracking-widest text-[#0A192F]">
                    Galería Visual
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {product.images.slice(1).map((img, idx) => (
                        <img
                            src={img}
                            alt={`${product?.title} - ${idx}`}
                            class="w-full h-64 object-cover rounded-sm hover:opacity-90 transition-opacity cursor-pointer"
                            loading="lazy"
                        />
                    ))}
                </div>
            </div>
        )
    }
</Layout>

<!-- Right Column: Sidebar -->
<div class="lg:col-span-4 relative">
    <div class="sticky top-32 space-y-10">
        <!-- Call to Action Card -->
        <div
            class="bg-white p-8 rounded-sm shadow-xl border border-gray-100 relative overflow-hidden"
        >
            <div
                class="absolute top-0 right-0 w-20 h-20 bg-brand-accent/10 rounded-bl-full -mr-10 -mt-10"
            >
            </div>

            <div class="mb-8">
                <span
                    class="text-xs font-bold uppercase tracking-widest text-gray-400 block mb-1"
                    >Valor de Inversión</span
                >
                <span class="text-4xl font-serif text-[#0A192F] font-bold block"
                    >{formatPrice(product.price, product.currency)}</span
                >
            </div>

            <div class="space-y-4">
                <a
                    href={waLink}
                    target="_blank"
                    class="flex items-center justify-center gap-3 w-full bg-[#0A192F] text-white py-4 px-6 text-xs font-bold uppercase tracking-[0.2em] hover:bg-brand-accent hover:text-[#0A192F] transition-all shadow-lg group"
                >
                    <MessageCircle size={18} />
                    <span>Agendar Visita</span>
                </a>
                <a
                    href="tel:+50687332630"
                    class="flex items-center justify-center gap-3 w-full border border-gray-200 text-[#0A192F] py-4 px-6 text-xs font-bold uppercase tracking-[0.2em] hover:border-[#0A192F] transition-all"
                >
                    <Phone size={18} />
                    <span>Llamada Directa</span>
                </a>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100 text-center">
                <div
                    class="flex items-center justify-center gap-2 text-brand-accent mb-2"
                >
                    <ShieldCheck size={20} />
                    <span class="text-xs font-bold uppercase tracking-wider"
                        >Garantía M2</span
                    >
                </div>
                <p class="text-[10px] text-gray-400 leading-tight">
                    Transacción supervisada por equipo legal. <br /> Depósito de garantía
                    custodiado.
                </p>
            </div>
        </div>

        <!-- Similar Properties -->
        {
            similarProducts.length > 0 && (
                <div>
                    <h4 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-6">
                        Propiedades Similares
                    </h4>
                    <div class="space-y-6">
                        {similarProducts.map((sim) => (
                            <a
                                href={`/propiedades/${sim.sku}`}
                                class="flex gap-4 group"
                            >
                                <div class="w-20 h-20 shrink-0 overflow-hidden rounded-sm relative">
                                    <img
                                        src={
                                            sim.thumbnail ||
                                            "/assets/hero-slider/hero-1.png"
                                        }
                                        class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                                    />
                                </div>
                                <div>
                                    <h5 class="text-sm font-bold text-[#0A192F] leading-tight mb-1 group-hover:text-brand-accent transition-colors line-clamp-2">
                                        {sim.title}
                                    </h5>
                                    <span class="text-xs font-mono text-gray-500">
                                        {formatPrice(sim.price, sim.currency)}
                                    </span>
                                </div>
                            </a>
                        ))}
                    </div>
                </div>
            )
        }
    </div>
</div>
