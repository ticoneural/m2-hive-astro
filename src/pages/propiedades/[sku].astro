---
import Layout from '../../layouts/Layout.astro';
import PropertyGallery from '../../components/PropertyGallery.astro';
import TrustBadge from '../../components/TrustBadge.astro';
import type { Product } from '../../types';

const { sku } = Astro.params;
let product: Product | null = null;
let error = null;

if (!sku) {
  return Astro.redirect('/404');
}

try {
  const response = await fetch(`https://api-m2.agenticantnest.com/api/v1/products/${sku}`);
  if (!response.ok) {
     if(response.status === 404) return Astro.redirect('/404');
     throw new Error(`API Error: ${response.statusText}`);
  }
  product = await response.json();
} catch (e) {
  console.error(e);
  error = "Propiedad no encontrada o error de conexión.";
}

if (!product) {
    return Astro.redirect('/404');
}

// Specs Mapping
const specs = {
    beds: product.specifications?.bedrooms || product.specifications?.cuartos || 'N/A',
    baths: product.specifications?.bathrooms || product.specifications?.baños || 'N/A',
    sqm: product.specifications?.size || product.specifications?.size_m2 || product.specifications?.metros || 'N/A',
    parking: product.specifications?.parking_spaces || product.specifications?.parking || product.specifications?.parqueo || '0'
};

const formatPrice = (val: number, currency = "USD") => {
    return new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: currency,
        maximumFractionDigits: 0,
    }).format(val || 0);
};

const waLink = `https://wa.me/50688888888?text=${encodeURIComponent(`Hola, me interesa la propiedad: ${product.title} (${product.sku}).`)}`;
const title = `${product.title} | M2 Real Estate`;
const description = product.description ? product.description.substring(0, 160) + '...' : `Propiedad exclusiva en ${product.category}.`;
const image = product.images?.[0] || '/og-default.jpg';
---

<Layout title={title} description={description} image={image}>
    <!-- Cinematic Hero -->
    <div class="relative h-[80vh] w-full overflow-hidden bg-brand-primary">
       <div class="absolute inset-0 animate-scale-reveal">
           {product.images && product.images.length > 0 ? (
               <img
                   src={product.images[0]}
                   alt={product.title}
                   class="h-full w-full object-cover opacity-60"
               />
           ) : (
               <div class="h-full w-full bg-gray-900 opacity-60 flex items-center justify-center text-white">No Image Available</div>
           )}
           <div class="absolute inset-0 bg-gradient-to-t from-brand-primary via-transparent to-transparent"></div>
       </div>
    
       <div class="absolute bottom-0 left-0 w-full p-6 pb-20 md:p-20">
           <div class="container mx-auto">
               <span class="inline-block mb-4 border border-brand-accent px-3 py-1 text-xs font-bold uppercase tracking-widest text-brand-accent bg-brand-primary/80 backdrop-blur-sm animate-fade-in-up">
                   {product.category || 'Exclusive Collection'}
               </span>
               <h1 class="max-w-4xl font-serif text-5xl text-white md:text-7xl animate-fade-in-up delay-100 drop-shadow-lg leading-tight">
                   {product.title}
               </h1>
               <p class="mt-4 max-w-xl text-xl text-gray-200 animate-fade-in-up delay-200">
                   {product.sku} | {specs.sqm} m²
               </p>
           </div>
       </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-16">
       <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
           <!-- Left Column: Details & Gallery -->
           <div class="lg:col-span-8 space-y-16">
               <!-- Specs Bar -->
               <div class="flex justify-between border-y border-brand-surface py-8">
                   <div class="text-center">
                       <span class="block font-serif text-3xl text-brand-head">{specs.sqm}</span>
                       <span class="text-xs font-bold uppercase tracking-wider text-brand-text">m² Construcción</span>
                   </div>
                   <div class="h-12 w-[1px] bg-brand-surface"></div>
                   <div class="text-center">
                       <span class="block font-serif text-3xl text-brand-head">{specs.beds}</span>
                       <span class="text-xs font-bold uppercase tracking-wider text-brand-text">Cuartos</span>
                   </div>
                   <div class="h-12 w-[1px] bg-brand-surface"></div>
                   <div class="text-center">
                       <span class="block font-serif text-3xl text-brand-head">{specs.baths}</span>
                       <span class="text-xs font-bold uppercase tracking-wider text-brand-text">Baños</span>
                   </div>
                    <div class="h-12 w-[1px] bg-brand-surface"></div>
                    <div class="text-center">
                       <span class="block font-serif text-3xl text-brand-head">{specs.parking}</span>
                       <span class="text-xs font-bold uppercase tracking-wider text-brand-text">Parqueo</span>
                   </div>
               </div>
    
               <!-- Description -->
               <div class="prose prose-invert prose-lg text-brand-text max-w-none">
                   <h3 class="font-serif text-2xl text-brand-head mb-4">Descripción</h3>
                   <p class="whitespace-pre-line leading-relaxed">{product.description || "Consulte para más detalles."}</p>
               </div>
               
               <!-- Additional Specs -->
               {product.specifications && Object.keys(product.specifications).length > 4 && (
               <div class="bg-gray-50 p-8 rounded-lg border border-gray-100">
                   <h4 class="font-serif text-xl mb-6 text-brand-surface">Detalles Adicionales</h4>
                   <div class="grid grid-cols-2 md:grid-cols-3 gap-y-4 gap-x-8 text-sm text-gray-700">
                       {Object.entries(product.specifications).map(([key, val]) => (
                           !['bedrooms', 'bathrooms', 'size_m2', 'parking', 'cuartos', 'baños', 'metros', 'parqueo', 'location'].includes(key) && (
                            <div class="flex flex-col">
                               <span class="font-bold uppercase text-xs text-gray-400 mb-1">{key.replace(/_/g, ' ')}</span>
                               <span class="font-medium text-gray-900">{String(val)}</span>
                            </div>
                           )
                       ))}
                   </div>
               </div>
               )}
    
               <!-- Gallery Component -->
               {product.images && product.images.length > 0 && (
                   <PropertyGallery images={product.images} title={product.title} />
               )}
           </div>
    
           <!-- Right Column: Sticky Price -->
           <div class="lg:col-span-4 relative">
               <div class="sticky top-24 space-y-8">
                   <!-- Price Card -->
                   <div class="glass-panel p-8 rounded-sm bg-white shadow-xl border border-gray-100">
                       <span class="block text-xs font-bold uppercase tracking-wider text-brand-text mb-2">Precio de Venta</span>
                       <div class="font-serif text-4xl text-brand-accent mb-6">
                           {formatPrice(product.price, product.currency)}
                       </div>
    
                       <a
                           href={waLink}
                           target="_blank"
                           class="block w-full text-center bg-green-600 text-white font-bold py-4 uppercase tracking-widest hover:bg-green-700 transition-colors duration-300 rounded-md shadow-lg hover:shadow-green-500/30"
                       >
                           Contactar Agente
                       </a>
                       
                       <p class="text-center text-xs text-gray-500 mt-4">
                           Consultas protegidas y confidenciales vía WhatsApp.
                       </p>
                   </div>
                   
                   <div class="mt-8 flex justify-center">
                       <TrustBadge type="sugef" />
                   </div>
               </div>
           </div>
       </div>
    </div>
</Layout>
