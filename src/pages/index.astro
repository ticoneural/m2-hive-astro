---
import Layout from "../layouts/Layout.astro";
import ListingCard from "../components/ListingCard.astro";
import {
	Search,
	Home,
	Building,
	LandPlot,
	Store,
	ArrowRight,
	CheckCircle2,
	FileCheck,
	Camera,
} from "lucide-astro";
import type { Product, Category } from "../types";

let products: Product[] = [];
let categories: Category[] = [];
let error = null;

try {
	const [prodRes, catRes] = await Promise.all([
		fetch("https://api-m2.agenticantnest.com/api/v1/products"),
		fetch("https://api-m2.agenticantnest.com/api/v1/categories"),
	]);

	if (!prodRes.ok) throw new Error("Failed to fetch products");

	const prodData = await prodRes.json();
	products = prodData.data || [];

	if (catRes.ok) {
		const catData = await catRes.json();
		const rawCategories: Category[] = catData || [];

		// Deduplicate categories logic
		const uniqueCats = new Map<string, Category>();

		rawCategories.forEach((cat) => {
			const key = cat.name
				.trim()
				.toLowerCase()
				.normalize("NFD")
				.replace(/[\u0300-\u036f]/g, "");

			if (uniqueCats.has(key)) {
				const existing = uniqueCats.get(key)!;
				existing.count += cat.count;
				if (cat.name !== existing.name) {
					if (
						cat.name[0] === cat.name[0].toUpperCase() &&
						existing.name[0] !== existing.name[0].toUpperCase()
					) {
						existing.name = cat.name;
					} else if (cat.name.length > existing.name.length) {
						existing.name = cat.name;
					}
				}
			} else {
				uniqueCats.set(key, { ...cat });
			}
		});

		categories = Array.from(uniqueCats.values());
	}
} catch (e) {
	console.error(e);
	error = "Algunos datos no están disponibles en este momento.";
}

// Get latest 3 for "Just Listed"
const latestProducts = products.slice(0, 3);

// Property Types (Static for now, could be dynamic later)
const propertyTypes = [
	{ name: "Casas Independientes", icon: Home, count: 12, slug: "casas" },
	{
		name: "Condominios & Torres",
		icon: Building,
		count: 8,
		slug: "condominios",
	},
	{ name: "Lotes & Quintas", icon: LandPlot, count: 5, slug: "lotes" },
	{ name: "Comercial", icon: Store, count: 3, slug: "comercial" },
];
---

<Layout title="M2 Real Estate | Agencia Inmobiliaria Profesional">
	<!-- Hero Section with Quick Search -->
	<section
		class="relative h-[85vh] min-h-[600px] flex items-center justify-center overflow-hidden bg-[#0A192F]"
	>
		<!-- Background Slider -->
		<div class="absolute inset-0 z-0">
			<div
				class="absolute inset-0 bg-gradient-to-b from-[#0A192F]/70 via-[#0A192F]/40 to-[#0A192F] z-10"
			>
			</div>
			<img
				src="/assets/hero-slider/hero-1.png"
				alt="Propiedad Destacada"
				class="w-full h-full object-cover opacity-60 animate-pan-slow"
			/>
		</div>

		<!-- Main Content -->
		<div class="relative z-20 container mx-auto px-6 mt-10">
			<div class="max-w-4xl mx-auto text-center mb-10">
				<span
					class="inline-block py-1 px-3 border border-brand-accent/30 rounded-full text-brand-accent text-[10px] font-bold uppercase tracking-widest mb-6 backdrop-blur-sm"
				>
					Agencia Inmobiliaria Premium
				</span>
				<h1
					class="text-4xl md:text-6xl font-serif text-white font-bold mb-6 leading-tight drop-shadow-lg"
				>
					Encontramos su <span class="text-brand-accent italic"
						>próximo activo</span
					>
					<br />
					en el momento correcto.
				</h1>
				<p
					class="text-gray-300 text-lg font-light max-w-2xl mx-auto leading-relaxed"
				>
					Asesoría experta en compra, venta y gestión de patrimonio
					inmobiliario en el Gran Área Metropolitana.
				</p>
			</div>

			<!-- Quick Search Box -->
			<div
				class="bg-white p-4 rounded-lg shadow-2xl max-w-4xl mx-auto transform translate-y-8 backdrop-blur-xl bg-opacity-95 border border-white/20"
			>
				<form
					action="/propiedades"
					class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end"
				>
					<!-- Location -->
					<div class="md:col-span-3">
						<label
							class="block text-[10px] font-bold uppercase text-gray-400 mb-2 tracking-wider"
							>Ubicación</label
						>
						<div class="relative">
							<select
								name="category"
								class="w-full bg-gray-50 border border-gray-200 rounded-md py-3 px-4 text-sm text-[#0A192F] focus:ring-2 focus:ring-brand-accent/50 outline-none appearance-none font-bold"
							>
								<option value="">Todas las zonas</option>
								{
									categories.map((cat) => (
										<option value={cat.name}>
											{cat.name}
										</option>
									))
								}
							</select>
							<div
								class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"
							>
								<svg
									xmlns="http://www.w3.org/2000/svg"
									class="h-4 w-4"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
									><path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M19 9l-7 7-7-7"></path></svg
								>
							</div>
						</div>
					</div>

					<!-- Transaction Type -->
					<div class="md:col-span-2">
						<label
							class="block text-[10px] font-bold uppercase text-gray-400 mb-2 tracking-wider"
							>Operación</label
						>
						<div class="relative">
							<select
								name="transaction_type"
								class="w-full bg-gray-50 border border-gray-200 rounded-md py-3 px-4 text-sm text-[#0A192F] focus:ring-2 focus:ring-brand-accent/50 outline-none appearance-none font-bold"
							>
								<option value="">Todos</option>
								<option value="sale">Venta</option>
								<option value="rent">Alquiler</option>
							</select>
							<div
								class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"
							>
								<svg
									xmlns="http://www.w3.org/2000/svg"
									class="h-4 w-4"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
									><path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M19 9l-7 7-7-7"></path></svg
								>
							</div>
						</div>
					</div>

					<!-- Property Type -->
					<div class="md:col-span-3">
						<label
							class="block text-[10px] font-bold uppercase text-gray-400 mb-2 tracking-wider"
							>Tipo Propiedad</label
						>
						<div class="relative">
							<select
								name="property_type"
								class="w-full bg-gray-50 border border-gray-200 rounded-md py-3 px-4 text-sm text-[#0A192F] focus:ring-2 focus:ring-brand-accent/50 outline-none appearance-none font-bold"
							>
								<option value="">Cualquira</option>
								<option value="house">Casas</option>
								<option value="apartment">Apartamentos</option>
								<option value="lot">Lotes</option>
								<option value="commercial">Comercial</option>
							</select>
							<div
								class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400"
							>
								<svg
									xmlns="http://www.w3.org/2000/svg"
									class="h-4 w-4"
									fill="none"
									viewBox="0 0 24 24"
									stroke="currentColor"
									><path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M19 9l-7 7-7-7"></path></svg
								>
							</div>
						</div>
					</div>

					<!-- Price Range (Simplified) -->
					<div class="md:col-span-2">
						<label
							class="block text-[10px] font-bold uppercase text-gray-400 mb-2 tracking-wider"
							>Max Precio</label
						>
						<div class="relative">
							<span
								class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-serif text-xs"
								>$</span
							>
							<input
								type="number"
								name="maxPrice"
								placeholder="Ej: 350k"
								class="w-full bg-gray-50 border border-gray-200 rounded-md py-3 pl-6 pr-2 text-sm text-[#0A192F] focus:ring-2 focus:ring-brand-accent/50 outline-none font-bold placeholder-gray-300"
							/>
						</div>
					</div>

					<!-- Submit -->
					<div class="md:col-span-2">
						<button
							type="submit"
							class="w-full bg-brand-accent hover:bg-white hover:text-brand-primary text-[#0A192F] font-bold uppercase tracking-widest py-3 px-6 rounded-md transition-all duration-300 shadow-lg flex items-center justify-center gap-2 group"
						>
							<Search size={18} />
							<span>Buscar Propiedades</span>
						</button>
					</div>
				</form>
			</div>
		</div>
	</section>

	<!-- Property Types Grid -->
	<section class="py-24 bg-gray-50">
		<div class="container mx-auto px-6">
			<div class="flex justify-between items-end mb-12">
				<div>
					<h2
						class="text-xs font-bold uppercase tracking-[0.2em] text-gray-400 mb-2"
					>
						Explorar Mercado
					</h2>
					<h3 class="text-3xl font-serif font-bold text-[#0A192F]">
						Tipos de Propiedad
					</h3>
				</div>
				<a
					href="/propiedades"
					class="hidden md:flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-brand-primary hover:text-brand-accent transition-colors"
				>
					Ver todo el inventario <ArrowRight size={16} />
				</a>
			</div>

			<div class="grid grid-cols-2 md:grid-cols-4 gap-6">
				{
					propertyTypes.map((type) => (
						<a
							href={`/propiedades?type=${type.slug}`}
							class="group bg-white p-8 rounded-sm shadow-sm hover:shadow-xl border border-gray-100 hover:border-brand-accent/30 transition-all duration-300 flex flex-col items-center text-center"
						>
							<div class="w-14 h-14 bg-gray-50 rounded-full flex items-center justify-center text-gray-400 group-hover:bg-brand-accent group-hover:text-white transition-all duration-300 mb-4">
								<type.icon size={24} />
							</div>
							<h4 class="text-sm font-bold text-[#0A192F] mb-1">
								{type.name}
							</h4>
							<p class="text-xs text-gray-400 group-hover:text-brand-accent transition-colors">
								Ver Oportunidades
							</p>
						</a>
					))
				}
			</div>
		</div>
	</section>

	<!-- New Arrivals -->
	<section class="py-24 bg-white relative">
		<div class="container mx-auto px-6">
			<div class="flex flex-col items-center text-center mb-16">
				<span class="w-12 h-1 bg-brand-accent mb-6"></span>
				<h2 class="text-4xl font-serif font-bold text-[#0A192F] mb-4">
					Recién Ingresados
				</h2>
				<p class="text-gray-500 max-w-xl">
					Las últimas oportunidades captadas por nuestro equipo de
					expertos. Disponibles para visita inmediata.
				</p>
			</div>

			{
				error ? (
					<div class="bg-red-50 text-red-600 p-8 text-center rounded-lg">
						{error}
					</div>
				) : (
					<div class="grid grid-cols-1 md:grid-cols-3 gap-8">
						{latestProducts.map((product) => (
							<ListingCard listing={product} />
						))}
					</div>
				)
			}

			<div class="mt-16 text-center">
				<a
					href="/propiedades"
					class="inline-flex items-center gap-2 px-8 py-4 bg-[#0A192F] text-white font-bold uppercase tracking-widest text-xs hover:bg-brand-accent hover:text-[#0A192F] transition-all duration-300 rounded-sm shadow-xl"
				>
					Explorar Todas las Propiedades
				</a>
			</div>
		</div>
	</section>

	<!-- Trust & Process (Why M2) -->
	<section class="py-24 bg-[#0A192F] border-t border-white/5">
		<div class="container mx-auto px-6">
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-center">
				<div>
					<h2
						class="text-brand-accent font-bold uppercase tracking-widest text-xs mb-4"
					>
						¿Por qué M2 Real Estate?
					</h2>
					<h3
						class="text-3xl md:text-5xl font-serif font-bold text-white mb-8 leading-tight"
					>
						Más que una inmobiliaria, <br />
						<span class="text-gray-400 italic"
							>su socio estratégico.</span
						>
					</h3>
					<p class="text-gray-400 leading-relaxed mb-10 font-light">
						Entendemos que comprar o vender es una decisión
						financiera mayor. Nuestro modelo se basa en datos,
						agilidad legal y resultados transparentes.
					</p>

					<div class="space-y-6">
						<div class="flex items-start gap-4">
							<div
								class="p-2 bg-white/5 rounded-lg text-emerald-400 mt-1"
							>
								<CheckCircle2 size={20} />
							</div>
							<div>
								<h4 class="text-white font-bold text-lg mb-1">
									Inventario Verificado
								</h4>
								<p class="text-sm text-gray-500">
									Cada propiedad pasa por un filtro legal y
									técnico antes de ser listada.
								</p>
							</div>
						</div>
						<div class="flex items-start gap-4">
							<div
								class="p-2 bg-white/5 rounded-lg text-brand-accent mt-1"
							>
								<FileCheck size={20} />
							</div>
							<div>
								<h4 class="text-white font-bold text-lg mb-1">
									Trámite Ágil
								</h4>
								<p class="text-sm text-gray-500">
									Gestión de documentos y coordinación
									bancaria para cierres rápidos.
								</p>
							</div>
						</div>
						<div class="flex items-start gap-4">
							<div
								class="p-2 bg-white/5 rounded-lg text-blue-400 mt-1"
							>
								<Camera size={20} />
							</div>
							<div>
								<h4 class="text-white font-bold text-lg mb-1">
									Marketing Profesional
								</h4>
								<p class="text-sm text-gray-500">
									Fotografía profesional y exposición en los
									canales correctos.
								</p>
							</div>
						</div>
					</div>
				</div>

				<div
					class="relative h-[600px] bg-gray-800 rounded-lg overflow-hidden group"
				>
					<div
						class="absolute inset-0 bg-gradient-to-t from-[#0A192F] to-transparent z-10 opacity-80"
					>
					</div>
					<img
						src="/assets/hero-slider/hero-2.png"
						alt="Agente Inmobiliario"
						class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all duration-1000 transform group-hover:scale-105"
					/>
					<div class="absolute bottom-10 left-10 z-20 max-w-xs">
						<p
							class="text-white font-serif text-2xl italic leading-relaxed"
						>
							"El compromiso de M2 con la transparencia transformó
							nuestra experiencia de compra."
						</p>
						<div class="mt-4 flex items-center gap-3">
							<div
								class="w-10 h-10 bg-brand-accent rounded-full flex items-center justify-center text-[#0A192F] font-bold"
							>
								RM
							</div>
							<div>
								<p
									class="text-white text-xs font-bold uppercase"
								>
									Roberto Martinez
								</p>
								<p
									class="text-brand-accent text-[10px] uppercase"
								>
									Comprador Verificado
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
</Layout>

<style>
	@keyframes pan-slow {
		0% {
			transform: scale(1.1);
		}
		100% {
			transform: scale(1);
		}
	}
	.animate-pan-slow {
		animation: pan-slow 20s ease-out forwards;
	}
</style>
